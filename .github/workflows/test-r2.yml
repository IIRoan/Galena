---
name: Test R2 credentials

on:
  workflow_dispatch:

jobs:
  test-r2:
    name: Test Cloudflare R2 connection
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Check secrets are set
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "Checking if secrets are configured..."

          MISSING=""
          [[ -z "$R2_ACCOUNT_ID" ]] && MISSING="$MISSING R2_ACCOUNT_ID"
          [[ -z "$R2_ACCESS_KEY_ID" ]] && MISSING="$MISSING R2_ACCESS_KEY_ID"
          [[ -z "$R2_SECRET_ACCESS_KEY" ]] && MISSING="$MISSING R2_SECRET_ACCESS_KEY"
          [[ -z "$R2_BUCKET_NAME" ]] && MISSING="$MISSING R2_BUCKET_NAME"

          if [[ -n "$MISSING" ]]; then
            echo "::error::Missing secrets:$MISSING"
            exit 1
          fi

          echo "All required secrets are set"
          echo "Account ID: ${R2_ACCOUNT_ID:0:8}... (truncated)"
          echo "Access Key ID: ${R2_ACCESS_KEY_ID:0:8}... (truncated)"
          echo "Bucket: $R2_BUCKET_NAME"

      - name: Configure rclone
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          mkdir -p ~/.config/rclone
          envsubst < iso/rclone/cloudflare-r2.conf > ~/.config/rclone/rclone.conf

      - name: Test bucket access (list)
        env:
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "Listing bucket contents..."
          rclone ls "cloudflare-r2:${R2_BUCKET_NAME}" --max-depth 1 || {
            echo "::error::Failed to list bucket. Check credentials and bucket name."
            exit 1
          }
          echo "Bucket listing successful"

      - name: Test upload permission
        env:
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "Testing upload permission..."
          echo "R2 credentials test - $(date)" > /tmp/r2-test.txt

          rclone copy /tmp/r2-test.txt "cloudflare-r2:${R2_BUCKET_NAME}/" --progress || {
            echo "::error::Failed to upload. Check that API token has write permission."
            exit 1
          }
          echo "Upload successful"

      - name: Test download permission
        env:
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "Testing download permission..."
          rclone copy "cloudflare-r2:${R2_BUCKET_NAME}/r2-test.txt" /tmp/downloaded/ --progress || {
            echo "::error::Failed to download."
            exit 1
          }
          cat /tmp/downloaded/r2-test.txt
          echo "Download successful"

      - name: Cleanup test file
        env:
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "Cleaning up test file..."
          rclone delete "cloudflare-r2:${R2_BUCKET_NAME}/r2-test.txt" || true
          echo "Cleanup complete"

      - name: Summary
        env:
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_DOMAIN: ${{ secrets.R2_PUBLIC_DOMAIN }}
        run: |
          echo "### R2 Connection Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets configured | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "| Bucket access | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "| Upload permission | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "| Download permission | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Bucket:** \`${R2_BUCKET_NAME}\`" >> $GITHUB_STEP_SUMMARY
          if [[ -n "$R2_PUBLIC_DOMAIN" ]]; then
            echo "**Public URL:** https://${R2_PUBLIC_DOMAIN}/" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Public URL:** Not configured (R2_PUBLIC_DOMAIN secret not set)" >> $GITHUB_STEP_SUMMARY
          fi
