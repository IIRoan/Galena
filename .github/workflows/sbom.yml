---
name: Generate SBOM
on:
  workflow_run:
    workflows:
      - Build container image
    types:
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: "Workflow run ID to pull build-manifest from"
        required: false

concurrency:
  group: sbom-${{ github.event.workflow_run.id || github.run_id }}
  cancel-in-progress: false

jobs:
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'

    permissions:
      actions: read
      contents: write
      packages: read
      id-token: write

    steps:
      - name: Resolve run ID
        id: run
        run: |
          run_id="${{ github.event.workflow_run.id }}"
          if [[ -n "${{ inputs.run_id }}" ]]; then
            run_id="${{ inputs.run_id }}"
          fi
          echo "run_id=${run_id}" >> "${GITHUB_OUTPUT}"

      - name: Download build manifest
        uses: actions/download-artifact@v4
        with:
          name: build-manifest
          run-id: ${{ steps.run.outputs.run_id }}
          path: ${{ github.workspace }}/artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse build manifest
        id: manifest
        run: |
          set -euo pipefail
          manifest_path="${{ github.workspace }}/artifacts/build-manifest.json"
          if [[ ! -f "${manifest_path}" ]]; then
            echo "build-manifest.json not found at ${manifest_path}"
            exit 1
          fi

          image_ref="$(jq -r '.version.image_ref' "${manifest_path}")"
          digest="$(jq -r '.images[0].digest' "${manifest_path}")"
          tag="$(jq -r '.images[0].tag' "${manifest_path}")"

          if [[ -z "${image_ref}" || "${image_ref}" == "null" ]]; then
            echo "image_ref missing in build-manifest.json"
            exit 1
          fi

          if [[ -z "${digest}" || "${digest}" == "null" ]]; then
            echo "digest missing in build-manifest.json"
            exit 1
          fi

          echo "image_ref=${image_ref}" >> "${GITHUB_OUTPUT}"
          echo "digest=${digest}" >> "${GITHUB_OUTPUT}"
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image for SBOM
        env:
          IMAGE: ${{ steps.manifest.outputs.image_ref }}
        run: |
          docker pull "${IMAGE}"

      - name: Resolve repo digest
        id: digest
        env:
          IMAGE_REF: ${{ steps.manifest.outputs.image_ref }}
        run: |
          set -euo pipefail
          repo_digest="$(docker image inspect --format '{{index .RepoDigests 0}}' "${IMAGE_REF}")"
          if [[ -z "${repo_digest}" ]]; then
            echo "No repo digest found for ${IMAGE_REF}"
            exit 1
          fi
          digest="${repo_digest##*@}"
          echo "repo_digest=${repo_digest}" >> "${GITHUB_OUTPUT}"
          echo "digest=${digest}" >> "${GITHUB_OUTPUT}"

      - name: Generate SBOM (Trivy)
        id: generate-sbom
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: image
          image-ref: ${{ steps.manifest.outputs.image_ref }}
          format: spdx-json
          output: ${{ runner.temp }}/sbom.spdx.json
        env:
          TRIVY_USERNAME: ${{ github.actor }}
          TRIVY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

      - name: Set SBOM output
        id: sbom-path
        run: echo "SBOM_PATH=${{ runner.temp }}/sbom.spdx.json" >> "${GITHUB_OUTPUT}"

      - name: Upload SBOM artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: sbom-spdx-json
          path: ${{ runner.temp }}/sbom.spdx.json
          if-no-files-found: error

      - name: Check signing secret
        id: signing
        run: |
          if [[ -n "${{ secrets.SIGNING_SECRET }}" ]]; then
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          else
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Install Cosign
        if: steps.signing.outputs.enabled == 'true'
        uses: sigstore/cosign-installer@v3

      - name: Attest SBOM
        if: steps.signing.outputs.enabled == 'true'
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.SIGNING_SECRET }}
        run: |
          cosign attest --yes --predicate "${{ steps.sbom-path.outputs.SBOM_PATH }}" --type spdxjson "${{ steps.digest.outputs.repo_digest }}"

      - name: Write SBOM summary
        if: always()
        env:
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          IMAGE: ${{ steps.manifest.outputs.image_ref }}
          DIGEST: ${{ steps.digest.outputs.digest }}
          TAG: ${{ steps.manifest.outputs.tag }}
          SBOM_PATH: ${{ steps.sbom-path.outputs.SBOM_PATH }}
          RESULT: ${{ steps.generate-sbom.outcome }}
        run: |
          {
            echo "## SBOM Summary"
            echo ""
            echo "| Property | Value |"
            echo "| --- | --- |"
            echo "| Outcome | ${RESULT} |"
            echo "| Image | \`${IMAGE}\` |"
            echo "| Tag | \`${TAG}\` |"
            echo "| Digest | \`${DIGEST}\` |"
            echo "| SBOM Path | \`${SBOM_PATH}\` |"
            if [[ -n "${RUN_URL}" ]]; then
              echo "| Build Run | ${RUN_URL} |"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"
