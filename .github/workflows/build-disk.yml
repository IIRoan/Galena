---
name: Build disk images

on:
  workflow_dispatch:
    inputs:
      image_type:
        description: 'Disk image type to build'
        required: true
        default: 'anaconda-iso'
        type: choice
        options:
          - anaconda-iso
          - iso
          - qcow2
          - raw
          - vmdk
      image_ref:
        description: 'Container image reference (leave empty for default)'
        required: false
        type: string
      upload_to_r2:
        description: 'Upload to Cloudflare R2'
        required: false
        default: true
        type: boolean

env:
  IMAGE_NAME: "${{ github.event.repository.name }}"
  IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}"
  DEFAULT_TAG: "main"
  GO_VERSION: "1.24.2"

jobs:
  build-disk:
    name: Build ${{ inputs.image_type }} image
    runs-on: ubuntu-24.04

    permissions:
      contents: read
      packages: read

    steps:
      - name: Prepare environment
        run: |
          echo "IMAGE_REGISTRY=${IMAGE_REGISTRY,,}" >> ${GITHUB_ENV}
          echo "IMAGE_NAME=${IMAGE_NAME,,}" >> ${GITHUB_ENV}

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install Podman
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Build galena
        run: |
          go build -o ${{ github.workspace }}/galena ./cmd/galena-build/
          chmod +x ${{ github.workspace }}/galena

      - name: Setup CI environment
        run: ${{ github.workspace }}/galena ci setup

      - name: Maximize build space
        uses: ublue-os/remove-unwanted-software@517622d6452028f266b7ba4cc9a123b5f58a6b53 # v7
        with:
          remove-codeql: true

      - name: Login to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image reference
        id: image
        run: |
          if [[ -n "${{ inputs.image_ref }}" ]]; then
            echo "ref=${{ inputs.image_ref }}" >> $GITHUB_OUTPUT
          else
            IMAGE_REF="${IMAGE_REGISTRY}/${IMAGE_NAME}:${{ env.DEFAULT_TAG }}"
            echo "ref=${IMAGE_REF}" >> $GITHUB_OUTPUT
          fi

      - name: Build disk image
        id: build
        run: |
          mkdir -p output

          # Run with sudo - bootc-image-builder requires rootful podman
          sudo ${{ github.workspace }}/galena disk ${{ inputs.image_type }} \
            --image ${{ steps.image.outputs.ref }} \
            --output ./output

          # Fix permissions for upload steps
          sudo chown -R $USER:$USER output/

      - name: Setup rclone
        if: inputs.upload_to_r2
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Upload to Cloudflare R2
        if: inputs.upload_to_r2
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_DOMAIN: ${{ secrets.R2_PUBLIC_DOMAIN }}
        run: |
          # Generate rclone config from template by substituting secrets
          mkdir -p ~/.config/rclone
          envsubst < iso/rclone/cloudflare-r2.conf > ~/.config/rclone/rclone.conf

          DATE_TAG=$(date +%Y%m%d)

          for file in output/**/*; do
            [[ -f "$file" ]] || continue
            FILENAME=$(basename "$file")
            EXTENSION="${FILENAME##*.}"
            BASENAME="${FILENAME%.*}"

            # Upload with date-tagged name
            rclone copyto "$file" "cloudflare-r2:${R2_BUCKET_NAME}/${BASENAME}-${DATE_TAG}.${EXTENSION}" \
              --progress

            # Copy as latest
            rclone copyto "$file" "cloudflare-r2:${R2_BUCKET_NAME}/${BASENAME}-latest.${EXTENSION}" \
              --progress

            echo "Uploaded: ${BASENAME}-${DATE_TAG}.${EXTENSION}"
            echo "Uploaded: ${BASENAME}-latest.${EXTENSION}"
          done

          # Output public URL if configured
          if [[ -n "${R2_PUBLIC_DOMAIN}" ]]; then
            echo "### R2 Downloads" >> $GITHUB_STEP_SUMMARY
            for file in output/**/*; do
              [[ -f "$file" ]] || continue
              FILENAME=$(basename "$file")
              EXTENSION="${FILENAME##*.}"
              BASENAME="${FILENAME%.*}"
              echo "- [${BASENAME}-${DATE_TAG}.${EXTENSION}](https://${R2_PUBLIC_DOMAIN}/${BASENAME}-${DATE_TAG}.${EXTENSION})" >> $GITHUB_STEP_SUMMARY
              echo "- [${BASENAME}-latest.${EXTENSION}](https://${R2_PUBLIC_DOMAIN}/${BASENAME}-latest.${EXTENSION})" >> $GITHUB_STEP_SUMMARY
            done
          fi

      - name: Upload disk image artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ env.IMAGE_NAME }}-${{ inputs.image_type }}
          path: output/
          compression-level: 0
          retention-days: 7

      - name: Write build summary
        if: always()
        env:
          IMAGE_TYPE: ${{ inputs.image_type }}
          IMAGE_REF: ${{ steps.image.outputs.ref }}
          BUILD_OUTCOME: ${{ steps.build.outcome }}
          UPLOAD_R2: ${{ inputs.upload_to_r2 }}
        run: |
          file_list="n/a"
          if [[ -d output ]]; then
            file_list=$(ls -1 output 2>/dev/null | tr '\n' ',' | sed 's/,$//')
            if [[ -z "${file_list}" ]]; then
              file_list="none"
            fi
          fi
          {
            echo "## Disk Image Summary"
            echo ""
            echo "| Property | Value |"
            echo "| --- | --- |"
            echo "| Outcome | ${BUILD_OUTCOME} |"
            echo "| Image Type | ${IMAGE_TYPE} |"
            echo "| Image Ref | \`${IMAGE_REF}\` |"
            echo "| Upload to R2 | ${UPLOAD_R2} |"
            echo "| Output Files | ${file_list} |"
          } >> "${GITHUB_STEP_SUMMARY}"
