---
name: Build container image
on:
  pull_request:
    branches:
      - main
  schedule:
    - cron: '05 10 * * *'  # 10:05am UTC everyday
  push:
    branches:
      - main
    paths-ignore:
      - '**/README.md'
  workflow_dispatch:

env:
  IMAGE_DESC: "Galena Linux"
  IMAGE_KEYWORDS: "bootc,ublue,universal-blue"
  IMAGE_LOGO_URL: "https://avatars.githubusercontent.com/u/120078124?s=200&v=4"  # Put your own image here for a fancy profile on https://artifacthub.io/!
  IMAGE_NAME: "${{ github.event.repository.name }}"  # output image name, usually same as repo name
  IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}"  # do not edit
  DEFAULT_TAG: "stable"
  GO_VERSION: "1.23"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}-${{ inputs.brand_name}}-${{ inputs.stream_name }}
  cancel-in-progress: false

jobs:
  build_push:
    name: Build and push image
    runs-on: ubuntu-24.04

    permissions:
      contents: read
      packages: write
      id-token: write

    outputs:
      image: ${{ steps.build.outputs.image }}
      tags: ${{ steps.build.outputs.tags }}
      digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.build.outputs.version }}
      should_push: ${{ steps.flags.outputs.should_push }}
      should_sign: ${{ steps.flags.outputs.should_sign }}

    steps:
      - name: Prepare environment
        run: |
          # Lowercase the image uri
          echo "IMAGE_REGISTRY=${IMAGE_REGISTRY,,}" >> ${GITHUB_ENV}
          echo "IMAGE_NAME=${IMAGE_NAME,,}" >> ${GITHUB_ENV}

      # These stage versions are pinned by https://github.com/renovatebot/renovate
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      # This is optional, but if you see that your builds are way too big for the runners, you can enable this by uncommenting the following lines:
      # - name: Maximize build space
      #   uses: ublue-os/remove-unwanted-software@517622d6452028f266b7ba4cc9a123b5f58a6b53 # v7
      #   with:
      #     remove-codeql: true

      - name: Mount BTRFS for podman storage
        id: container-storage-action
        uses: ublue-os/container-storage-action@911baca08baf30c8654933e9e9723cb399892140 # main
        # Fallback to the remove-unwanted-software-action if github doesn't allocate enough space
        # See: https://github.com/ublue-os/container-storage-action/pull/11
        continue-on-error: true
        with:
          target-dir: /var/lib/containers
          mount-opts: compress-force=zstd:2

      - name: Setup Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build galena
        run: |
          go build -ldflags "-s -w \
            -X github.com/iiroan/galena/cmd/galena/cmd.Version=${{ github.sha }} \
            -X github.com/iiroan/galena/cmd/galena/cmd.Commit=${{ github.sha }} \
            -X github.com/iiroan/galena/cmd/galena/cmd.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o ${{ github.workspace }}/galena ./cmd/galena/
          chmod +x ${{ github.workspace }}/galena
          ${{ github.workspace }}/galena version

      - name: Setup CI environment
        run: ${{ github.workspace }}/galena ci setup

      - name: Compute build flags
        id: flags
        run: |
          is_pr="false"
          is_same_repo="false"
          is_default_branch="false"

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            is_pr="true"
            if [[ "${{ github.event.pull_request.head.repo.full_name }}" == "${{ github.repository }}" ]]; then
              is_same_repo="true"
            fi
          fi

          if [[ "${{ github.ref }}" == "refs/heads/${{ github.event.repository.default_branch }}" ]]; then
            is_default_branch="true"
          fi

          should_push="false"
          if [[ "${is_default_branch}" == "true" ]] || [[ "${is_pr}" == "true" && "${is_same_repo}" == "true" ]]; then
            should_push="true"
          fi

          tags_override=""
          if [[ "${is_pr}" == "true" && "${is_same_repo}" == "true" ]]; then
            tags_override="testing"
          fi

          {
            echo "is_pr=${is_pr}"
            echo "is_same_repo=${is_same_repo}"
            echo "is_default_branch=${is_default_branch}"
            echo "should_push=${should_push}"
            echo "should_sign=${should_push}"
            echo "tags_override=${tags_override}"
          } >> "${GITHUB_OUTPUT}"

      # These `if` statements are so that pull requests for your custom images do not make it publish any packages under your name without you knowing
      # They also check if the runner is on the default branch so that things like the merge queue (if you enable it), are going to work
      - name: Login to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        if: steps.flags.outputs.should_push == 'true'
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        if: steps.flags.outputs.should_sign == 'true'

      - name: Build and push image
        id: build
        env:
          IMAGE_DESC: ${{ env.IMAGE_DESC }}
          IMAGE_KEYWORDS: ${{ env.IMAGE_KEYWORDS }}
          IMAGE_LOGO_URL: ${{ env.IMAGE_LOGO_URL }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          IMAGE_REGISTRY: ${{ env.IMAGE_REGISTRY }}
          GALENA_CI_TAGS: ${{ steps.flags.outputs.tags_override }}
        run: |
          PUSH_FLAG=""
          if [[ "${{ steps.flags.outputs.should_push }}" == "true" ]]; then
            PUSH_FLAG="--push"
          fi

          SIGN_FLAG=""
          if [[ "${{ steps.flags.outputs.should_sign }}" == "true" ]]; then
            SIGN_FLAG="--sign"
          fi

          # Run the build
          ${{ github.workspace }}/galena ci build \
            --default-tag "${{ env.DEFAULT_TAG }}" \
            $PUSH_FLAG \
            $SIGN_FLAG

      - name: Upload build manifest
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: build-manifest
          path: build-manifest.json
          if-no-files-found: ignore

      - name: Write build summary
        if: github.event_name == 'pull_request' && always()
        env:
          BUILD_OUTCOME: ${{ steps.build.outcome }}
          IMAGE: ${{ steps.build.outputs.image }}
          TAGS: ${{ steps.build.outputs.tags }}
          DIGEST: ${{ steps.build.outputs.digest }}
          VERSION: ${{ steps.build.outputs.version }}
          PUSHED: ${{ steps.flags.outputs.should_push == 'true' && steps.build.outcome == 'success' }}
          SIGNED: ${{ steps.flags.outputs.should_sign == 'true' && steps.build.outcome == 'success' }}
        run: |
          image_display="${IMAGE:-n/a}"
          tags_display="${TAGS:-n/a}"
          digest_display="${DIGEST:-n/a}"
          version_display="${VERSION:-n/a}"
          test_image="${IMAGE_REGISTRY}/${IMAGE_NAME}:testing"
          {
            echo "## Build Summary"
            echo ""
            echo "| Property | Value |"
            echo "| --- | --- |"
            echo "| Outcome | ${BUILD_OUTCOME} |"
            echo "| Image | \`${image_display}\` |"
            echo "| Tags | ${tags_display} |"
            echo "| Version | \`${version_display}\` |"
            echo "| Digest | \`${digest_display}\` |"
            echo "| Pushed | ${PUSHED} |"
            echo "| Signed | ${SIGNED} |"
            echo "| Testing Tag | \`${test_image}\` |"
          } >> "${GITHUB_STEP_SUMMARY}"

  workflow_summary:
    name: Workflow Summary
    runs-on: ubuntu-24.04
    needs:
      - build_push
    if: always()
    steps:
      - name: Write workflow summary
        env:
          BUILD_RESULT: ${{ needs.build_push.result }}
          IMAGE: ${{ needs.build_push.outputs.image }}
          TAGS: ${{ needs.build_push.outputs.tags }}
          DIGEST: ${{ needs.build_push.outputs.digest }}
          PUSHED: ${{ needs.build_push.outputs.should_push }}
          SIGNED: ${{ needs.build_push.outputs.should_sign }}
        run: |
          {
            echo "## Workflow Summary"
            echo ""
            echo "| Property | Value |"
            echo "| --- | --- |"
            echo "| Build Result | ${BUILD_RESULT} |"
            echo "| Image | \`${IMAGE}\` |"
            echo "| Tags | ${TAGS} |"
            echo "| Digest | \`${DIGEST}\` |"
            echo "| Pushed | ${PUSHED} |"
            echo "| Signed | ${SIGNED} |"
          } >> "${GITHUB_STEP_SUMMARY}"
